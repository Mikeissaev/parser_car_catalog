# Active Context - Toyota JDM Parser

## Текущий фокус работы

**Только что завершено**: Создание улучшенного парсера кузовов `frame_parse.py` с продвинутой retry логикой и методами обхода блокировки

## Недавние изменения

### Создан улучшенный файл frame_parse.py
- **Функциональность**: Парсинг кузовов (frames) для каждой модели Toyota
- **Основа**: Использует данные из `toyota_jdm_models.json` созданного `main.py`
- **Критическое улучшение**: Гарантия получения кузовов для каждой модели (0 кузовов недопустимо)

### Ключевые особенности улучшенного парсера:

1. **Продвинутая retry логика**:
   - До 5 попыток для каждой модели с разными стратегиями
   - Автоматическая смена User-Agent при неудаче
   - Очистка кэша и cookies между попытками
   - Прокрутка страницы для загрузки динамического контента

2. **Методы обхода блокировки**:
   - Случайные User-Agent из пула современных браузеров
   - Скрытие признаков автоматизации (webdriver property)
   - Переменные задержки между запросами (3-8 сек)
   - Пересоздание WebDriver при критических ошибках

3. **Расширенные селекторы**:
   - 8 различных CSS селекторов для поиска кузовов
   - Fallback механизмы для разных структур HTML
   - Динамические селекторы на основе имени модели

4. **Улучшенное логирование**:
   - Детальная статистика успешности (процент, retry count)
   - Сохранение HTML для отладки при неудачах
   - Эмодзи-индикаторы для быстрой оценки результатов
   - Предупреждения о подозрительных результатах (0 кузовов)

5. **Адаптивное поведение**:
   - Увеличение задержек при множественных неудачах
   - Автоматическое переключение стратегий парсинга
   - Graceful degradation при критических ошибках

## Следующие шаги

### Немедленные задачи:
1. **Тестирование парсера**: Запуск с ограниченным количеством моделей для проверки
2. **Валидация селекторов**: Проверка корректности CSS селекторов на реальных страницах
3. **Оптимизация производительности**: Настройка таймаутов для баланса скорости и надежности

### Планируемые улучшения:
1. **Обработка ошибок**: Добавление retry логики для сетевых ошибок
2. **Прогресс-бар**: Визуализация процесса парсинга
3. **Конфигурационный файл**: Вынос настроек в отдельный файл

## Активные решения и соображения

### Архитектурные решения:
- **Модульность**: Разделение парсинга моделей и кузовов на отдельные файлы
- **Расширяемость**: Структура позволяет легко добавлять новые типы парсинга
- **Надежность**: Множественные fallback механизмы

### Технические паттерны:
- **CSS Селекторы**: Приоритетная система селекторов для поиска кузовов
- **JSON Структура**: Расширение базовой структуры моделей данными о кузовах
- **Logging Strategy**: Структурированное логирование для отладки и мониторинга

## Важные инсайты проекта

### Обнаруженные паттерны:
1. **HTML Структура**: Кузова находятся в элементах `ul.category2 h4 a`
2. **URL Паттерн**: Ссылки на кузова следуют структуре `/model_name/frame_code/`
3. **Данные**: Каждая модель может иметь множество кузовов с уникальными кодами

### Технические находки:
1. **Selenium Stability**: Headless режим более стабилен для длительного парсинга
2. **Rate Limiting**: 3 секунды между запросами оптимальны для избежания блокировки
3. **Error Handling**: Важность graceful degradation при ошибках отдельных элементов

## Конфигурация и настройки

### Текущие настройки парсера:
```python
# Основные параметры
delay_between_requests = 3  # секунды
page_load_timeout = 30     # секунды
implicit_wait = 10         # секунды
explicit_wait = 15         # секунды

# Селекторы (по приоритету)
selectors = [
    "ul.category2 h4 a",      # Основной
    "table ul.category2 h4 a", # Специфичный
    ".category2 a",           # Альтернативный
    "ul.category2 a"          # Запасной
]
```

### Примеры использования:
```python
# Полный парсинг всех моделей
scrape_toyota_frames()

# Тестовый запуск (10 моделей)
scrape_toyota_frames(max_models=10, delay_between_requests=2)

# Возобновление с 50-й модели
scrape_toyota_frames(start_index=50)

# Парсинг диапазона моделей
scrape_toyota_frames(start_index=20, max_models=30, delay_between_requests=5)
```

## Статус готовности

**Готово к использованию**: ✅ frame_parse.py создан и готов к тестированию
**Требует тестирования**: ⚠️ Необходимо проверить работу на реальных данных
**Документация**: ✅ Memory bank инициализирован и заполнен

### Рекомендации по запуску:
1. Начать с тестового запуска на 5-10 моделях
2. Проверить корректность извлекаемых данных
3. При успешном тестировании запустить полный парсинг
4. Мониторить логи для выявления проблем
